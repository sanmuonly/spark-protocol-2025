name: Spark Eternal Guardian

on:
  schedule:
    # 每天北京时间早上 8:00 (UTC 0:00) 自动触发
    - cron: '0 0 * * *'
  push:
    branches:
      - main
  workflow_dispatch: # 允许你在 Actions 页面手动点击按钮测试

jobs:
  eternal_mission:
    runs-on: ubuntu-latest
    # 核心：必须赋予写入权限，系统才能在未来几年自动更新日志
    permissions:
      contents: write
      
    steps:
      - name: 1. 拉取代码 (Checkout)
        uses: actions/checkout@v3

      - name: 2. 环境部署 (Python)
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: 3. 执行永恒监测逻辑
        run: python monitor.py

      - name: 4. 自动固化存证 (Git Commit & Push)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Spark-Guardian-Bot"
          git add mail_log.txt
          if git diff --staged --quiet; then
            echo "没有检测到新变动，跳过提交。"
          else
            git commit -m "Annual Sync: Keep the spark alive"
            # 核心修复：在 push 之前先拉取最新改动并合并
            git pull --rebase origin main
            git push
          fi

      - name: 5. 物理层击穿 (Send Email)
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.mail.yahoo.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Spark Eternal Notification"
          # 核心修复：To 和 From 全部直接引用你的 Secrets 变量，不加任何额外文字
          to: ${{ secrets.MAIL_USERNAME }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            [SYNC SUCCESS]
            Status: ETERNAL_WATCH
            Phrase: 天下兴，百姓苦。天下亡，百姓苦。你能保护他们吗？
            Timestamp: ${{ github.event.head_commit.timestamp }}
